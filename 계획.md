# GitHub Actions 기반 CI/CD 및 Slack 알림 구축 계획

## 1. 프로젝트 목표 및 범위
- GitHub Actions 워크플로우 하나로 빌드, 테스트, 도커 이미지 생성, 배포를 자동화한다.
- 각 단계의 시작/성공/실패 여부를 Slack 채널로 실시간 전파한다.
- 기능 검증을 위해 최소 구성의 프런트엔드 서버를 포함한 PoC 저장소를 구성한다.

## 2. 저장소 구조 초안
- `frontend/`: Vite 기반 React TypeScript 애플리케이션, 단일 페이지와 간단한 테스트 코드 포함
- `.github/workflows/ci-cd.yml`: 통합 워크플로우 정의
- `scripts/`: 공용 스크립트(예: Slack 통지용 Node/TS 스크립트, 승인 대기 스크립트) 저장
- `infra/` (선택): 환경 변수 템플릿, 배포 문서 등

## 3. Vite 프런트엔드 PoC 구성 계획
- `npm create vite@latest frontend -- --template react-ts` 기반 초기화
- UI 구성
  - "Slack Bot PoC" 문구와 GitHub Actions + Slack 승인 흐름 안내 카드
  - 헬스 체크 버튼 및 상태 표시(테스트 유도용 가짜 API 호출)
- 단위 테스트: React Testing Library + Vitest로 버튼 상호작용 및 상태 전환 검증
- 빌드 커맨드: `npm run build` → `dist/` 산출물 생성
- 테스트 커맨드: `npm run test`

## 4. Slack 봇 연동 전략
- Slack App 생성 후 Bot Token, Signing Secret, App-Level Token(Socket Mode용) 확보 → GitHub Secret으로 저장 (`SLACK_BOT_TOKEN`, `SLACK_SIGNING_SECRET`, `SLACK_APP_TOKEN` 등)
- 메시지 전송 방식
  - (안) `slackapi/slack-github-action` 활용: 워크플로우 내에서 간편 호출
  - (또는) 커스텀 Node 스크립트(`scripts/slack-notify.ts`) 작성 후 `node`로 실행
- 메시지 포맷: 단계별 제목, 상태(✅/❌), 실행 시간, 로그 링크(`github.run_id`) 포함
- 실패 시 `if: failure()` 조건을 사용해 별도 알림 발송
- **배포 승인 플로우**
  - Slack Block Kit을 사용해 `승인`/`거절` 버튼 포함 메시지 전송
  - GitHub Actions Job에서 Socket Mode로 Slack 인터랙션을 대기하는 스크립트(`scripts/slack-approval-waiter.ts`) 실행
  - 승인 시 GitHub Actions에 승인 결과를 반환하여 후속 Job 진행, 거절 시 워크플로우 실패 처리 및 Slack 알림 전송

## 5. GitHub Actions 워크플로우 설계
### 5.1 트리거
- `push` 및 `pull_request` - `main` 대상으로 우선 설정
- 수동 실행(`workflow_dispatch`) 지원으로 재실행 가능

### 5.2 공통 설정
- `env`: Slack 채널 ID, Docker 이미지 이름, 배포 대상 등 공통 변수 정의
- `concurrency`: 동일 브랜치 동시 실행 제한
- `permissions`: `packages: write` (GHCR 푸시), `contents: read`

### 5.3 Job 구성
1. **setup-and-test**
   - OS: `ubuntu-latest`
   - 단계
     1. Slack에 "빌드 시작" 알림 전송
     2. 체크아웃 및 Node 버전 설정(`actions/setup-node` + 캐시)
     3. `npm ci`, `npm run lint`(선택), `npm run test`, `npm run build`
     4. `actions/upload-pages-artifact`로 `dist/` 업로드
     5. 성공/실패 알림 전송

2. **docker-build-and-push** (needs: setup-and-test)
   - Docker 빌드 및 GHCR(`ghcr.io/<org>/<repo>`) 푸시
   - `docker/build-push-action` 사용, 태그: 커밋 SHA 및 `latest`
   - Slack에 상태 알림 전송

3. **approval-gate** (needs: docker-build-and-push)
   - Slack에 "배포를 승인하시겠습니까?" 메시지 전송(Block Kit 버튼 포함)
   - `node scripts/slack-approval-waiter.ts` 실행하여 Socket Mode로 버튼 클릭 이벤트 대기
   - 승인 시 Slack에 승인 로그 남기고 Job 성공, 거절 또는 타임아웃 시 실패처리 후 워크플로우 중단

4. **deploy** (needs: approval-gate)
   - `actions/configure-pages`로 GitHub Pages 설정
   - `actions/deploy-pages`로 `dist/` 아티팩트 배포
   - Slack에 성공/실패 알림 전송, 배포 URL 포함

5. **post-deploy-verify** (선택)
   - 배포 서버 헬스 체크(HTTP GET)
   - 결과를 Slack으로 공유

## 6. 시크릿 및 환경 변수 정리
- `SLACK_BOT_TOKEN`, `SLACK_APP_TOKEN`, `SLACK_CHANNEL_ID`
- `SLACK_APPROVER_USER_IDS` (슬랙 승인 허용 사용자 목록, CSV 형태)
- `GHCR_USERNAME`, `GHCR_TOKEN` (또는 `GITHUB_TOKEN` 사용)
- 배포 대상 SSH 정보: `DEPLOY_HOST`, `DEPLOY_USER`, `DEPLOY_KEY`
- 기타: 배포 URL, 환경 명(`ENVIRONMENT_NAME`)

## 7. 검증 계획
- 각 Job 실패 시 워크플로우가 즉시 Slack으로 실패 알림을 보내는지 확인
- 의도적으로 테스트 실패/빌드 실패/배포 실패를 유발해 단계별 동작 검증
- Docker 이미지가 GHCR에 생성되는지 확인 후 수동 pull 테스트
- 배포 서버에서 애플리케이션 헬스 체크 및 롤백 시나리오(구버전 이미지 재배포) 검토

- **Day 1**: Vite 앱 초기화, 기본 UI/상태 관리 및 테스트 구현
- **Day 2**: Slack 알림/승인 스크립트 구현, GitHub Actions 초안 작성
- **Day 3**: Dockerfile/compose 작성, GHCR 연동, 배포 잡 구현
- **Day 4**: 통합 테스트, 예외 시나리오 검증, 문서화(README, 알림 예시 스크린샷)

## 9. 향후 확장 고려사항
- 멀티 환경 지원(`dev`, `staging`, `prod`) 및 승인 단계 추가
- Slack 스레드 활용 또는 메시지 리치 포맷(Block Kit) 적용
- Sentry, Datadog 등 모니터링 연동
- Helm chart 또는 IaC(Terraform)와의 통합으로 배포 자동화 고도화

